<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>PostgreSQL Performance Farm</title>

    <base href="http://localhost:8080/">

    <script src="scripts/request.js"></script>
    <script src="scripts/common.js"></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/d3js/6.7.0/d3.min.js"></script>

</head>

<body>

    <div id="navigation"></div>

    <div id="page-content">

        <div class="card">
            <div id="page-title">Average TPS and latency in milliseconds : <span id="value_alias"></span></div>
        </div>

        <div class="card">

            <div class="title">Owner : <span id="value_owner"></span></div>

            <div class="space-vertical"></div>

            <div><span id="value_os"></span></div>
            <div><span id="value_compiler"></span></div>

        </div>

        <div class="card">

            <div class="title">Command Line</div>

            <div class="space-vertical"></div>

            <div><span id="value_command"></span></div>

            <div class="space-vertical"></div>

            <button onclick="copy()">Copy Command</button>

        </div>

        <div class="card">

            <div class="title">Benchmark Configuration</div>

            <div class="space-vertical"></div>

            <div>Clients : <span id="value_client"></span></div>
            <div>Scale : <span id="value_scale"></span></div>
            <div>Duration : <span id="value_duration"></span></div>
            <div><span id="value_read_write"></span></div>

        </div>

        <div id="trend__chart__list"></div>

    </div>

    <script>
        
        const id = getUrlParam('id');
        const config = getUrlParam('config');
        const chartListElement = document.querySelector('#trend__chart__list');

        sendRequest(endpoints.trend + id + '/' + config, (response) => {

            const main = response[0];

            const alias = main.alias;
			const owner = main.username;
			const id = main.machine_id;

			const clients = main.clients;
            const duration = main.duration;
            const scale = main.scale;

            let read_only = '';
            let read_only_command = '';

            if(main.read_only == true) {
                read_only = "Read-only Test";
                read_only_command = '-S';
            } else {
                read_only = "Read-write Test";
            }

            const os = main.kernel_name + ' ' + main.dist_name + ' ' + main.machine_type;
            const compiler = main.compiler;

            const commad = `pgbench -i -s ${scale} -p 5432 && pgbench -r -c ${clients} -j ${clients} -T ${duration} -l --aggregate-interval 1 ${read_only_command}`;

            const chartData = {};

            // group by branch name
            for(const item of response) {

                const branch = item.name;

                if (!(branch in chartData)) chartData[branch] = [];

                chartData[branch].push(item);

            }

            // sort each branch by time
            for(let [branch, branchArray] of Object.entries(chartData)) {

                branchArray.sort(function(a, b) {
                    const aDate = new Date(a.add_time), bDate = new Date(b.add_time);
                    if (aDate < bDate) return -1;
                    else if (aDate > bDate) return 1;
                    else return 0;
                });

                branchArray = branchArray.map((value) => {
                    return {
                        ...value,
                        commit: value.git_commit.slice(0, 10)
                    };
                });

                let append = `

                    <div class="card">

                        <div class="title">${branch}</div>
                        
                        <div class="space-vertical"></div>

                        <div id="canvas-${branch}" class="trend__chart"></div>

                        <div class="space-vertical"></div>

                        <table class="table-outline" border="1">

                            <thead>
                                <th>Commit</th>
                                <th>Average Latency</th>
                                <th>STD Latency</th>
                                <th>Average TPS</th>
                                <th>STD TPS</th>
                                <th>Min Latency</th>
                                <th>Max Latency</th>
                                <th>Min TPS</th>
                                <th>Max TPS</th>
                            </thead>

                            <tbody>

                `;

                for(const item of branchArray) {

                    append += `
                    <tr>
                        <td><a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=${item.git_commit}">${item.commit}</a></td>
                        <td>${item.avglat}</td>
                        <td>${item.stdlat}</td>
                        <td>${item.avgtps}</td>
                        <td>${item.stdtps}</td>
                        <td>${item.minlat}</td>
                        <td>${item.maxlat}</td>
                        <td>${item.mintps}</td>
                        <td>${item.maxtps}</td>
                    </tr>
                    `;

                }

                append += '</tbody></table></div>';

                chartListElement.innerHTML += append;

                drawChart("canvas-" + branch, branchArray);

            }

            document.querySelector('#value_alias').innerHTML = alias;
            document.querySelector('#value_owner').innerHTML = owner;
            document.querySelector('#value_os').innerHTML = os;
            document.querySelector('#value_compiler').innerHTML = compiler;
            document.querySelector('#value_command').innerHTML = commad;
            document.querySelector('#value_client').innerHTML = clients;
            document.querySelector('#value_scale').innerHTML = scale;
            document.querySelector('#value_duration').innerHTML = duration;
            document.querySelector('#value_read_write').innerHTML = read_only;

        });

        const copy = () => {

			const command = document.getElementById('value_command').innerHTML;

			const element = document.createElement('textarea');
			element.value = command;
			document.body.appendChild(element);
			element.select();
			document.execCommand('copy');
			document.body.removeChild(element);

    	};

        const drawChart = (elementId, branchArray) => {

            const blue = '#303F9F';
            const blueLight = '#8D97D6';
            const red = '#C2185B';
            const redLight = '#E198B5';

            const commitList = branchArray.map((value) => value.commit);
            let maxLatency = branchArray[0].maxlat * 1.2;
            let minLatency = branchArray[0].minlat * 0.8;
            let maxTps = branchArray[0].maxtps * 1.2;
            let minTps = branchArray[0].mintps * 0.8;

            for(const item of branchArray) {

                if (item.maxlat > maxLatency) maxLatency = item.maxlat;
                if (item.minlat < minLatency) minLatency = item.minlat;
                if (item.maxtps > maxTps) maxTps = item.maxtps;
                if (item.mintps < minTps) minTps = item.mintps;

            }

            const canvasElement = document.getElementById(elementId);
            const canvasWidth = canvasElement.parentElement.clientWidth - 40;
            const canvasHeight = 500;
            const canvasPadding = 70;
            const graphWidth = canvasWidth - canvasPadding*2;
            const graphHeight = canvasHeight - canvasPadding*2;

            const canvas = d3.select('#' + elementId);

            const svg = canvas
                .append('svg')
                .attr('width', canvasWidth)
                .attr('height', canvasHeight);

            const xScale = d3
                .scalePoint()
                .domain(commitList)
                .range([0, graphWidth])
                .padding(0.1);

            const latencyScale = d3
                .scaleLinear()
                .domain([minLatency, maxLatency])
                .range([graphHeight, 0]);

            const tpsScale = d3
                .scaleLinear()
                .domain([minTps, maxTps])
                .range([graphHeight, 0]);

            const latencyLine = d3
                .line()
                .x((d) => xScale(d.commit) + canvasPadding)
                .y((d) => latencyScale(d.avglat) + canvasPadding);

            const tpsLine = d3
                .line()
                .x((d) => xScale(d.commit) + canvasPadding)
                .y((d) => tpsScale(d.avgtps) + canvasPadding);

            // background
            svg
                .append('rect')
                .attr('width', canvasWidth)
                .attr('height', canvasHeight)
                .attr('fill', '#FAFAFA');

            // commit axis
            svg
                .append('g')
                .attr('transform', `translate(${canvasPadding}, ${canvasHeight-canvasPadding})`)
                .call(d3.axisBottom(xScale));

            svg
                .append('text')
                .attr('class', 'x-axis')
                .attr('x', canvasWidth/2)
                .attr('y', canvasHeight - 10)
                .text('Commit');

            // latency axis
            svg
                .append('g')
                .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`)
                .call(d3.axisLeft(latencyScale));

            svg
                .append('text')
                .attr('class', 'y-axis')
                .attr('x', 10)
                .attr('y', canvasHeight/2)
                .text('Latency (s)');

            // tps axis
            svg
                .append('g')
                .attr('transform', `translate(${canvasWidth-canvasPadding}, ${canvasPadding})`)
                .call(d3.axisRight(tpsScale));

            svg
                .append('text')
                .attr('class', 'y-axis')
                .attr('x', canvasWidth - 10)
                .attr('y', canvasHeight/2)
                .text('TPS (transaction/s)');

            // legend
            svg
                .append('circle')
                .attr('cx', canvasWidth - 130)
                .attr('cy', 25)
                .attr('r', 4)
                .style('fill', blue)

            svg
                .append('text')
                .attr('x', canvasWidth - 120)
                .attr('y', 25)
                .style('font-size', '11px')
                .attr('alignment-baseline', 'middle')
                .text('Latency');

            svg
                .append('circle')
                .attr('cx', canvasWidth - 60)
                .attr('cy', 25)
                .attr('r', 4)
                .style('fill', red)

            svg
                .append('text')
                .attr('x', canvasWidth - 50)
                .attr('y', 25)
                .style('font-size', '11px')
                .attr('alignment-baseline', 'middle')
                .text('TPS');

            // latency
            for(const item of branchArray) {

                svg
                    .append('line')
                    .attr('stroke', blueLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit))
                    .attr("y1", latencyScale(item.maxlat))
                    .attr("x2", xScale(item.commit))
                    .attr("y2", latencyScale(item.minlat))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

                svg
                    .append('line')
                    .attr('stroke', blueLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit) - 5)
                    .attr("y1", latencyScale(item.maxlat))
                    .attr("x2", xScale(item.commit) + 5)
                    .attr("y2", latencyScale(item.maxlat))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

                svg
                    .append('line')
                    .attr('stroke', blueLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit) - 5)
                    .attr("y1", latencyScale(item.minlat))
                    .attr("x2", xScale(item.commit) + 5)
                    .attr("y2", latencyScale(item.minlat))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

            }

            // tps
            for(const item of branchArray) {

                svg
                    .append('line')
                    .attr('stroke', redLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit))
                    .attr("y1", tpsScale(item.maxtps))
                    .attr("x2", xScale(item.commit))
                    .attr("y2", tpsScale(item.mintps))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

                svg
                    .append('line')
                    .attr('stroke', redLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit) - 5)
                    .attr("y1", tpsScale(item.maxtps))
                    .attr("x2", xScale(item.commit) + 5)
                    .attr("y2", tpsScale(item.maxtps))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

                svg
                    .append('line')
                    .attr('stroke', redLight)
                    .attr('stroke-width', '1.5px')
                    .attr("x1", xScale(item.commit) - 5)
                    .attr("y1", tpsScale(item.mintps))
                    .attr("x2", xScale(item.commit) + 5)
                    .attr("y2", tpsScale(item.mintps))
                    .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`);

            }

            // latency
            svg
                .append('path')
                .datum(branchArray)
                .attr('fill', 'none')
                .attr('stroke', blue)
                .attr('stroke-width', '1.5px')
                .attr('d', latencyLine);

            svg
                .selectAll('latencyDot')
                .data(branchArray)
                .enter()
                .append('circle')
                .attr('fill', blue)
                .attr('cx', (d) => xScale(d.commit))
                .attr('cy', (d) => latencyScale(d.avglat))
                .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`)
                .attr('r', 2);

            // tps
            svg
                .append('path')
                .datum(branchArray)
                .attr('fill', 'none')
                .attr('stroke', red)
                .attr('stroke-width', '1.5px')
                .attr('d', tpsLine);

            svg
                .selectAll('tpsDot')
                .data(branchArray)
                .enter()
                .append('circle')
                .attr('fill', red)
                .attr('cx', (d) => xScale(d.commit))
                .attr('cy', (d) => tpsScale(d.avgtps))
                .attr('transform', `translate(${canvasPadding}, ${canvasPadding})`)
                .attr('r', 2);

        };

    </script>

    <script src="components/navigation.js"></script>

    <link rel="stylesheet" type="text/css" href="styles/common.css">
    <link rel="stylesheet" type="text/css" href="styles/navigation.css">
    <link rel="stylesheet" type="text/css" href="trend/trend.css">

</body>

</html>
